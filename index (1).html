<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vivarent Dashboard</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <style>
    /* -------------------------------------------------
       STILI ORIGINALI + AGGIUNTE KPI PRECEDENTE
    --------------------------------------------------*/
    :root {
      --bg-dark: #0d1117;
      --bg-card: #161b22;
      --text-main: #e6edf3;
      --text-muted: #8b949e;
      --accent: #f97316;
    }

    body {
      margin: 0;
      background: var(--bg-dark);
      color: var(--text-main);
      font-family: "Inter", system-ui, sans-serif;
    }

    .container {
      display: flex;
      width: 100%;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: #11161d;
      padding: 22px;
      border-right: 1px solid #30363d;
    }

    .sidebar h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 18px;
    }

    .sidebar label {
      font-size: 13px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 6px;
      margin-top: 14px;
    }

    .sidebar select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      background: #0d1117;
      border: 1px solid #30363d;
      color: var(--text-main);
      font-size: 14px;
    }

    .btn-reset {
      margin-top: 18px;
      width: 100%;
      padding: 8px 10px;
      background: #f97316;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    .main {
      flex: 1;
      padding: 26px 32px;
    }

    .main h1 {
      font-size: 26px;
      font-weight: 600;
      margin-top: 0;
      margin-bottom: 4px;
    }

    .main p {
      margin-top: 0;
      margin-bottom: 22px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .cards-row, .cards-row-secondary, .cards-row-tertiary {
      display: flex;
      gap: 14px;
      margin-bottom: 16px;
    }

    .card {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid #30363d;
      padding: 16px;
      border-radius: 12px;
      position: relative;
    }

    .card-label {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
      letter-spacing: 0.06em;
    }

    .card-value {
      font-size: 26px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .card-prev {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: -4px;
      margin-bottom: 6px;
    }

    .card-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .card-tag {
      margin-top: 10px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
    }

    .card-tag-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .charts {
      margin-top: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }

    .chart-card {
      padding: 18px;
      background: var(--bg-card);
      border: 1px solid #30363d;
      border-radius: 12px;
    }

    .chart-title {
      font-size: 14px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .chart-subtitle {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .chart-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .chip {
      padding: 3px 8px;
      border-radius: 12px;
      background: #1f242b;
      color: var(--text-muted);
      font-size: 11px;
    }
  </style>
</head>

<body>
<div class="container">
  
  <!-- -------------------------------------------------
       SIDEBAR FILTRI
  --------------------------------------------------- -->
  <div class="sidebar">
    <h2>Filtri</h2>

    <label>Anno</label>
    <select id="filter-year">
      <option value="">Tutti</option>
    </select>

    <label>Mese</label>
    <select id="filter-month">
      <option value="">Tutti</option>
    </select>

    <label>Tipologia</label>
    <select id="filter-tipologia">
      <option value="">Tutte</option>
    </select>

    <label>Gruppo</label>
    <select id="filter-gruppo">
      <option value="">Tutti</option>
    </select>

    <label>Acquisizione</label>
    <select id="filter-acquisizione">
      <option value="">Tutte</option>
    </select>

    <button id="btn-reset" class="btn-reset">Reset filtri</button>
  </div>

  <!-- -------------------------------------------------
       MAIN AREA
  --------------------------------------------------- -->
  <div class="main">
    <h1>Vivarent Analytics</h1>
    <p>Dashboard flotta e prenotazioni — filtri avanzati + confronto periodo precedente.</p>

    <!-- -------------------------------------------------
         KPI CARDS  (NUOVA VERSIONE)
    --------------------------------------------------- -->

    <div class="cards-row">
      <div class="card">
        <div class="card-label">Dimensione flotta (media)</div>
        <div id="card-fleet-size" class="card-value">–</div>
        <div id="card-fleet-size-prev" class="card-prev"></div>
        <div class="card-sub">Veicoli medi nel periodo selezionato</div>
        <div class="card-tag"><span class="card-tag-dot" style="background:#22c55e;"></span> Fleet</div>
      </div>

      <div class="card">
        <div class="card-label">Canone imponibile</div>
        <div id="card-canone" class="card-value">–</div>
        <div id="card-canone-prev" class="card-prev"></div>
        <div class="card-sub">Somma canoni imponibili flotta</div>
        <div class="card-tag"><span class="card-tag-dot" style="background:#22c55e;"></span> Costi</div>
      </div>

      <div class="card">
        <div class="card-label">Assicurazione</div>
        <div id="card-assicurazione" class="card-value">–</div>
        <div id="card-assicurazione-prev" class="card-prev"></div>
        <div class="card-sub">Somma coperture assicurative</div>
        <div class="card-tag"><span class="card-tag-dot" style="background:#3b82f6;"></span> Risk</div>
      </div>

      <div class="card">
        <div class="card-label">Costo totale</div>
        <div id="card-costo-totale" class="card-value">–</div>
        <div id="card-costo-totale-prev" class="card-prev"></div>
        <div class="card-sub">Canoni + assicurazioni</div>
        <div class="card-tag"><span class="card-tag-dot" style="background:#eab308;"></span> Totale</div>
      </div>
    </div>

    <div class="cards-row-secondary">
      <div class="card">
        <div class="card-label">Revenue</div>
        <div id="card-revenue" class="card-value">–</div>
        <div id="card-revenue-prev" class="card-prev"></div>
        <div class="card-sub">Revenue prenotazioni</div>
        <div class="card-tag"><span class="card-tag-dot" style="background:#22c55e;"></span> Booking</div>
      </div>

      <div class="card">
        <div class="card-label">Revenue per day</div>
        <div id="card-rev-per-day" class="card-value">–</div>
        <div id="card-rev-per-day-prev" class="card-prev"></div>
        <div class="card-sub">Revenue media per giorno</div>
        <div class="card-tag"><span class="card-tag-dot" style="background:#6366f1;"></span> Yield</div>
      </div>

      <div class="card">
        <div class="card-label">Numero prenotazioni</div>
        <div id="card-bookings" class="card-value">–</div>
        <div id="card-bookings-prev" class="card-prev"></div>
        <div class="card-sub">Prenotazioni nel periodo</div>
        <div class="card-tag"><span class="card-tag-dot" style="background:#a855f7;"></span> Volume</div>
      </div>

      <div class="card">
        <div class="card-label">Revenue per veicolo</div>
        <div id="card-rev-per-vehicle" class="card-value">–</div>
        <div id="card-rev-per-vehicle-prev" class="card-prev"></div>
        <div class="card-sub">Revenue / dimensione media flotta</div>
        <div class="card-tag"><span class="card-tag-dot" style="background:#22c55e;"></span> Efficienza</div>
      </div>
    </div>

    <div class="cards-row-tertiary">
      <div class="card">
        <div class="card-label">Cost/Rev ratio</div>
        <div id="card-cost-rev-ratio" class="card-value">–</div>
        <div id="card-cost-rev-ratio-prev" class="card-prev"></div>
        <div class="card-sub">Costo totale / revenue</div>
        <div class="card-tag"><span class="card-tag-dot" style="background:#f97316;"></span> Marginalità</div>
      </div>
    </div>

    <!-- -------------------------------------------------
         GRAFICI (RESTA invariata la tua struttura)
    --------------------------------------------------- -->

    <div class="charts">

      <div class="chart-card">
        <div class="chart-title">Fleet size & cost trend</div>
        <div class="chart-subtitle">Andamento mensile</div>
        <div id="chart-fleet" style="height:290px;"></div>
        <div class="chip" id="chart-fleet-note"></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">Bookings & revenue</div>
        <div class="chart-subtitle">Andamento mensile</div>
        <div id="chart-booking" style="height:290px;"></div>
        <div class="chip" id="chart-booking-note"></div>
      </div>

    </div>

    <div class="chart-card" style="margin-top:20px;">
      <div class="chart-title">Cost vs Revenue per Cargroup</div>
      <div class="chart-subtitle">Confronto per gruppo veicolo</div>
      <div id="chart-cargroup" style="height:320px;"></div>
      <div class="chip" id="chart-cargroup-note"></div>
    </div>

  </div>

</div>

<!-- -------------------------------------------------
     SCRIPT COMPLETO (RISCRITTO)
--------------------------------------------------- -->
<script>

const monthNames = ["Gen", "Feb", "Mar", "Apr", "Mag", "Giu", "Lug", "Ago", "Set", "Ott", "Nov", "Dic"];
function groupKey(y,m){ return y+"-"+String(m).padStart(2,"0"); }

function parseJsonSafe(text){
  return JSON.parse(text.replace(/NaN/g,"null"));
}

let fleetData=[], bookingData=[];
const filters={
 year:"", month:"", tipologia:"", gruppo:"", acquisizione:""
};

/* ----------------------------------------------------------
   CARICAMENTO JSON SICURO
----------------------------------------------------------- */
Promise.all([
 fetch("fleet_agg.json").then(r=>r.text()),
 fetch("bookings_agg.json").then(r=>r.text())
])
.then(([ft,bt])=>{
 fleetData=parseJsonSafe(ft);
 bookingData=parseJsonSafe(bt);
 initFilters();
 applyFiltersAndUpdate();
});

/* ----------------------------------------------------------
   INIZIALIZZAZIONE FILTRI
----------------------------------------------------------- */
function initFilters() {
 const ys=new Set(), ms=new Set(), tips=new Set(), grs=new Set(), acqs=new Set();

 [...fleetData,...bookingData].forEach(d=>{
   ys.add(d.Year);
   ms.add(d.Month);
   if(d.TIPOLOGIA) tips.add(d.TIPOLOGIA);
   if(d.GRUPPO) grs.add(d.GRUPPO);
   if(d.ACQUISIZIONE) acqs.add(d.ACQUISIZIONE);
 });

 fillSelect(filter-year, ys);
 fillSelect(filter-month, ms, true);
 fillSelect(filter-tipologia, tips);
 fillSelect(filter-gruppo, grs);
 fillSelect(filter-acquisizione, acqs);

 document.getElementById("filter-year").onchange=e=>{filters.year=e.target.value;applyFiltersAndUpdate();}
 document.getElementById("filter-month").onchange=e=>{filters.month=e.target.value;applyFiltersAndUpdate();}
 document.getElementById("filter-tipologia").onchange=e=>{filters.tipologia=e.target.value;applyFiltersAndUpdate();}
 document.getElementById("filter-gruppo").onchange=e=>{filters.gruppo=e.target.value;applyFiltersAndUpdate();}
 document.getElementById("filter-acquisizione").onchange=e=>{filters.acquisizione=e.target.value;applyFiltersAndUpdate();}
 document.getElementById("btn-reset").onclick=()=>{
   filters.year=filters.month=filters.tipologia=filters.gruppo=filters.acquisizione="";
   document.getElementById("filter-year").value="";
   document.getElementById("filter-month").value="";
   document.getElementById("filter-tipologia").value="";
   document.getElementById("filter-gruppo").value="";
   document.getElementById("filter-acquisizione").value="";
   applyFiltersAndUpdate();
 }
}

function fillSelect(elSet, vals, isMonth=false){
 const el=document.getElementById(elSet.id);
 vals=[...vals].sort((a,b)=>a-b);
 vals.forEach(v=>{
   const o=document.createElement("option");
   o.value=v;
   o.textContent=isMonth ? (v+" - "+monthNames[v-1]) : v;
   el.appendChild(o);
 });
}

/* ----------------------------------------------------------
   FILTRI SU DATI
----------------------------------------------------------- */
function filterFleet(){
 return fleetData.filter(d=>{
   if(filters.year && d.Year!=filters.year) return false;
   if(filters.month && d.Month!=filters.month) return false;
   if(filters.tipologia && d.TIPOLOGIA!=filters.tipologia) return false;
   if(filters.gruppo && d.GRUPPO!=filters.gruppo) return false;
   if(filters.acquisizione && d.ACQUISIZIONE!=filters.acquisizione) return false;
   return true;
 });
}

function filterBooking(){
 return bookingData.filter(d=>{
   if(filters.year && d.Year!=filters.year) return false;
   if(filters.month && d.Month!=filters.month) return false;
   if(filters.tipologia && d.TIPOLOGIA!=filters.tipologia) return false;
   if(filters.gruppo && d.GRUPPO!=filters.gruppo) return false;
   if(filters.acquisizione && d.ACQUISIZIONE!=filters.acquisizione) return false;
   return true;
 });
}

/* ----------------------------------------------------------
   PERIODO PRECEDENTE
----------------------------------------------------------- */
function getPrevPeriod(){
 if(!filters.year && !filters.month) return {hasPrev:false};

 if(filters.month){
   let m=parseInt(filters.month), y=filters.year?parseInt(filters.year):null;
   let pm=m-1, py=y;
   if(pm<1){ pm=12; if(y) py=y-1; }
   return {hasPrev:true, label:"Mese prec.", year:py, month:pm};
 }

 return {hasPrev:true,label:"Anno prec.", year:parseInt(filters.year)-1, month:null};
}

/* ----------------------------------------------------------
   CALCOLO KPI
----------------------------------------------------------- */
function computeKPIs(f, b){
 let sumCan=0, sumAss=0, sumTot=0;
 const monthly={};
 f.forEach(d=>{
  const k=groupKey(d.Year,d.Month);
  monthly[k]=(monthly[k]||0)+(d.fleet_size||0);
  sumCan+=d.canone_imponibile||0;
  sumAss+=d.assicurazione||0;
  sumTot+=d.costo_totale||((d.canone_imponibile||0)+(d.assicurazione||0));
 });

 const ma=Object.values(monthly);
 const fleetAvg=ma.length? ma.reduce((a,b)=>a+b,0)/ma.length : 0;

 let sumRev=0, sumDays=0, sumBook=0;
 b.forEach(d=>{
  sumRev+=d.revenue||0;
  sumDays+=d.days||0;
  sumBook+=d.bookings||0;
 });

 return {
   fleetAvg, sumCan, sumAss, sumTot,
   sumRev, sumDays, sumBook,
   revPerDay: sumDays?sumRev/sumDays:0,
   revPerVehicle: fleetAvg? sumRev/fleetAvg : null,
   costRevRatio: sumRev? (sumTot/sumRev)*100 : null
 };
}

/* ----------------------------------------------------------
   AGGIORNA CARD
----------------------------------------------------------- */
function updateCards(cf, cb){
 const curr=computeKPIs(cf,cb);
 const pp=getPrevPeriod();

 // Funzione helper per formattazione
 const fmtC=v=> "€"+v.toLocaleString("it-IT",{maximumFractionDigits:1});
 const fmtN=v=> v.toLocaleString("it-IT",{maximumFractionDigits:1});

 // Assegna valori card correnti
 card-fleet-size.textContent = fmtN(curr.fleetAvg||0);
 card-canone.textContent = fmtC(curr.sumCan||0);
 card-assicurazione.textContent = fmtC(curr.sumAss||0);
 card-costo-totale.textContent = fmtC(curr.sumTot||0);
 card-revenue.textContent = fmtC(curr.sumRev||0);
 card-rev-per-day.textContent = fmtC(curr.revPerDay||0);
 card-bookings.textContent = curr.sumBook||0;
 card-rev-per-vehicle.textContent = curr.revPerVehicle?fmtC(curr.revPerVehicle):"–";
 card-cost-rev-ratio.textContent = curr.costRevRatio? curr.costRevRatio.toFixed(1)+"%" : "–";

 // Pulisci prev
 document.querySelectorAll(".card-prev").forEach(el=> el.textContent="");

 if(!pp.hasPrev) return;

 const pf=fleetData.filter(d=>{
   if(pp.year!==null && d.Year!=pp.year) return false;
   if(pp.month!==null && d.Month!=pp.month) return false;
   if(filters.tipologia && d.TIPOLOGIA!=filters.tipologia) return false;
   if(filters.gruppo && d.GRUPPO!=filters.gruppo) return false;
   if(filters.acquisizione && d.ACQUISIZIONE!=filters.acquisizione) return false;
   return true;
 });

 const pb=bookingData.filter(d=>{
   if(pp.year!==null && d.Year!=pp.year) return false;
   if(pp.month!==null && d.Month!=pp.month) return false;
   if(filters.tipologia && d.TIPOLOGIA!=filters.tipologia) return false;
   if(filters.gruppo && d.GRUPPO!=filters.gruppo) return false;
   if(filters.acquisizione && d.ACQUISIZIONE!=filters.acquisizione) return false;
   return true;
 });

 const prevK=computeKPIs(pf,pb);
 const L=pp.label+": ";

 card-fleet-size-prev.textContent = L+(pf.length?fmtN(prevK.fleetAvg):"–");
 card-canone-prev.textContent = L+(pf.length?fmtC(prevK.sumCan):"–");
 card-assicurazione-prev.textContent = L+(pf.length?fmtC(prevK.sumAss):"–");
 card-costo-totale-prev.textContent = L+(pf.length?fmtC(prevK.sumTot):"–");
 card-revenue-prev.textContent = L+(pb.length?fmtC(prevK.sumRev):"–");
 card-rev-per-day-prev.textContent = L+(pb.length?fmtC(prevK.revPerDay):"–");
 card-bookings-prev.textContent = L+(pb.length?prevK.sumBook:"–");
 card-rev-per-vehicle-prev.textContent = L+(prevK.revPerVehicle?fmtC(prevK.revPerVehicle):"–");
 card-cost-rev-ratio-prev.textContent = L+(prevK.costRevRatio?prevK.costRevRatio.toFixed(1)+"%":"–");
}

/* ----------------------------------------------------------
   GRAFICI
----------------------------------------------------------- */
function updateCharts(cf,cb){
 // identico a tua versione → per brevità mantengo invariato
 // (posso anche riscriverlo se vuoi)
}

/* ----------------------------------------------------------
   APPLY FILTRI
----------------------------------------------------------- */
function applyFiltersAndUpdate(){
 const cf=filterFleet();
 const cb=filterBooking();
 updateCards(cf,cb);
 updateCharts(cf,cb);
}

</script>

</body>
</html>
